[0m22:34:55.832500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017EFB7FE2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017EFA759E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017EFB7FC610>]}


============================== 22:34:55.833049 | 11a2009e-b994-40ed-a57b-f7d347b80242 ==============================
[0m22:34:55.833049 [info ] [MainThread]: Running with dbt=1.11.0-b4
[0m22:34:55.837640 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'partial_parse': 'True', 'empty': 'None', 'introspect': 'True', 'printer_width': '80', 'fail_fast': 'False', 'indirect_selection': 'eager', 'invocation_command': 'dbt debug', 'profiles_dir': 'C:\\Users\\zeyuz\\.dbt', 'use_colors': 'True', 'version_check': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'log_path': 'C:\\Users\\zeyuz\\OneDrive\\Desktop\\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\\DW Project End-to-End Pipeline\\dw_final_project\\include\\nba_dw_project\\logs', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'cache_selected_only': 'False', 'target_path': 'None', 'no_print': 'None', 'warn_error': 'None', 'debug': 'False'}
[0m22:34:55.855253 [info ] [MainThread]: dbt version: 1.11.0-b4
[0m22:34:55.855253 [info ] [MainThread]: python version: 3.11.14
[0m22:34:55.855253 [info ] [MainThread]: python path: C:\Users\zeyuz\anaconda3\envs\dbt_env\python.exe
[0m22:34:55.858587 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m22:34:56.343206 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m22:34:56.343206 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m22:34:56.343206 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m22:34:56.390736 [info ] [MainThread]: Using profiles dir at C:\Users\zeyuz\.dbt
[0m22:34:56.390736 [info ] [MainThread]: Using profiles.yml file at C:\Users\zeyuz\.dbt\profiles.yml
[0m22:34:56.390736 [info ] [MainThread]: Using dbt_project.yml file at C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\dbt_project.yml
[0m22:34:56.390736 [info ] [MainThread]: adapter type: snowflake
[0m22:34:56.390736 [info ] [MainThread]: adapter version: 1.10.3
[0m22:34:56.479438 [info ] [MainThread]: Configuration:
[0m22:34:56.483998 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m22:34:56.483998 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m22:34:56.483998 [info ] [MainThread]: Required dependencies:
[0m22:34:56.483998 [debug] [MainThread]: Executing "git --help"
[0m22:34:56.516956 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--no-lazy-fetch]\n           [--no-optional-locks] [--no-advice] [--bare] [--git-dir=<path>]\n           [--work-tree=<path>] [--namespace=<name>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m22:34:56.517652 [debug] [MainThread]: STDERR: "b''"
[0m22:34:56.518390 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m22:34:56.518390 [info ] [MainThread]: Connection:
[0m22:34:56.518390 [info ] [MainThread]:   account: azb79167
[0m22:34:56.518390 [info ] [MainThread]:   user: MARMOT
[0m22:34:56.518390 [info ] [MainThread]:   database: MLDS430
[0m22:34:56.518390 [info ] [MainThread]:   warehouse: TRAINING_WH
[0m22:34:56.518390 [info ] [MainThread]:   role: TRAINING_ROLE
[0m22:34:56.518390 [info ] [MainThread]:   schema: MARMOT_FINAL
[0m22:34:56.518390 [info ] [MainThread]:   authenticator: None
[0m22:34:56.518390 [info ] [MainThread]:   oauth_client_id: None
[0m22:34:56.518390 [info ] [MainThread]:   query_tag: None
[0m22:34:56.518390 [info ] [MainThread]:   client_session_keep_alive: False
[0m22:34:56.518390 [info ] [MainThread]:   host: None
[0m22:34:56.518390 [info ] [MainThread]:   port: None
[0m22:34:56.525480 [info ] [MainThread]:   proxy_host: None
[0m22:34:56.526226 [info ] [MainThread]:   proxy_port: None
[0m22:34:56.526226 [info ] [MainThread]:   protocol: None
[0m22:34:56.526226 [info ] [MainThread]:   connect_retries: 1
[0m22:34:56.526226 [info ] [MainThread]:   connect_timeout: None
[0m22:34:56.526226 [info ] [MainThread]:   retry_on_database_errors: False
[0m22:34:56.526226 [info ] [MainThread]:   retry_all: False
[0m22:34:56.526226 [info ] [MainThread]:   insecure_mode: False
[0m22:34:56.526226 [info ] [MainThread]:   reuse_connections: True
[0m22:34:56.526226 [info ] [MainThread]:   s3_stage_vpce_dns_name: None
[0m22:34:56.526226 [info ] [MainThread]:   platform_detection_timeout_seconds: 0.0
[0m22:34:56.526226 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m22:34:56.723116 [debug] [MainThread]: Acquiring new snowflake connection 'debug'
[0m22:34:56.920136 [debug] [MainThread]: Using snowflake connection "debug"
[0m22:34:56.920762 [debug] [MainThread]: On debug: select 1 as id
[0m22:34:56.920762 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:34:57.847064 [debug] [MainThread]: SQL status: SUCCESS 1 in 0.936 seconds
[0m22:34:57.847064 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m22:34:57.847064 [info ] [MainThread]: [32mAll checks passed![0m
[0m22:34:57.847064 [debug] [MainThread]: Command `dbt debug` succeeded at 22:34:57.847064 after 2.14 seconds
[0m22:34:57.847064 [debug] [MainThread]: Connection 'debug' was left open.
[0m22:34:57.847064 [debug] [MainThread]: On debug: Close
[0m22:34:58.023478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017EFB84B8D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017EFC154850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017EF98BCB90>]}
[0m22:34:58.023478 [debug] [MainThread]: Flushing usage events
[0m22:34:58.208251 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:35:35.829358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA8204F5D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA83291290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA832FA1D0>]}


============================== 22:35:35.829358 | 0a0b1cce-7940-49a0-98bd-04527aab2230 ==============================
[0m22:35:35.829358 [info ] [MainThread]: Running with dbt=1.11.0-b4
[0m22:35:35.845355 [debug] [MainThread]: running dbt with arguments {'static_parser': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'partial_parse': 'True', 'empty': 'False', 'introspect': 'True', 'printer_width': '80', 'fail_fast': 'False', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'profiles_dir': 'C:\\Users\\zeyuz\\.dbt', 'use_colors': 'True', 'version_check': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'log_path': 'C:\\Users\\zeyuz\\OneDrive\\Desktop\\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\\DW Project End-to-End Pipeline\\dw_final_project\\include\\nba_dw_project\\logs', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'cache_selected_only': 'False', 'target_path': 'None', 'no_print': 'None', 'warn_error': 'None', 'debug': 'False'}
[0m22:35:36.284772 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m22:35:36.284772 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m22:35:36.284772 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m22:35:36.456601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA832D4C90>]}
[0m22:35:36.502129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA812D6690>]}
[0m22:35:36.504429 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m22:35:36.707663 [debug] [MainThread]: checksum: 57e51233fb2305050a86c940b93938a4d3a51a7b95f45f76840a20ffa12695aa, vars: {}, profile: , target: , version: 1.11.0b4
[0m22:35:36.707663 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:35:36.707663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA8498B390>]}
[0m22:35:37.590916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAFFA46750>]}
[0m22:35:37.635839 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\manifest.json
[0m22:35:37.637841 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\semantic_manifest.json
[0m22:35:37.660785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA84754590>]}
[0m22:35:37.661791 [info ] [MainThread]: Found 3 models, 1 source, 494 macros
[0m22:35:37.661791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA8467DDD0>]}
[0m22:35:37.661791 [info ] [MainThread]: 
[0m22:35:37.661791 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:35:37.661791 [info ] [MainThread]: 
[0m22:35:37.661791 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:35:37.669269 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m22:35:37.814367 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m22:35:37.814367 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m22:35:37.814367 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:38.598061 [debug] [ThreadPool]: SQL status: SUCCESS 99 in 0.782 seconds
[0m22:35:38.602803 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m22:35:38.603330 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m22:35:39.070677 [debug] [ThreadPool]: SQL status: SUCCESS 99 in 0.469 seconds
[0m22:35:39.070677 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now create_MLDS430_MARMOT_FINAL_staging)
[0m22:35:39.070677 [debug] [ThreadPool]: Creating schema "database: "MLDS430"
schema: "MARMOT_FINAL_staging"
"
[0m22:35:39.082917 [debug] [ThreadPool]: Using snowflake connection "create_MLDS430_MARMOT_FINAL_staging"
[0m22:35:39.082917 [debug] [ThreadPool]: On create_MLDS430_MARMOT_FINAL_staging: create schema if not exists MLDS430.MARMOT_FINAL_staging
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "create_MLDS430_MARMOT_FINAL_staging"} */
[0m22:35:39.248210 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.172 seconds
[0m22:35:39.248210 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_MLDS430_MARMOT_FINAL_staging, now create_MLDS430_MARMOT_FINAL_marts)
[0m22:35:39.248210 [debug] [ThreadPool]: Creating schema "database: "MLDS430"
schema: "MARMOT_FINAL_marts"
"
[0m22:35:39.248210 [debug] [ThreadPool]: Using snowflake connection "create_MLDS430_MARMOT_FINAL_marts"
[0m22:35:39.248210 [debug] [ThreadPool]: On create_MLDS430_MARMOT_FINAL_marts: create schema if not exists MLDS430.MARMOT_FINAL_marts
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "create_MLDS430_MARMOT_FINAL_marts"} */
[0m22:35:39.394607 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.148 seconds
[0m22:35:39.410264 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430_MARMOT_FINAL_staging'
[0m22:35:39.419059 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL_staging"
[0m22:35:39.419059 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL_staging: show objects in MLDS430.MARMOT_FINAL_staging
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL_staging"} */;
[0m22:35:39.419059 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:39.879700 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.467 seconds
[0m22:35:39.879700 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL_staging, now list_MLDS430_MARMOT_FINAL_marts)
[0m22:35:39.888858 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL_marts"
[0m22:35:39.888858 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL_marts: show objects in MLDS430.MARMOT_FINAL_marts
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL_marts"} */;
[0m22:35:40.007167 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.116 seconds
[0m22:35:40.007167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA8478D7D0>]}
[0m22:35:40.007167 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m22:35:40.007167 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL_staging.stg_nba_stats ................. [RUN]
[0m22:35:40.007167 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.nba_dw_project.stg_nba_stats'
[0m22:35:40.007167 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m22:35:40.007167 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m22:35:40.023264 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m22:35:40.049634 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m22:35:40.054966 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m22:35:40.054966 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL_staging.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT *,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m22:35:40.055967 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:35:40.587343 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01c0bad3-0307-278c-000e-9ce300b121a6
[0m22:35:40.587343 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 70 at position 8
invalid identifier 'EXTRACTION_TIMESTAMP'
[0m22:35:40.590458 [debug] [Thread-1 (]: Database Error in model stg_nba_stats (models\staging\stg_nba_stats.sql)
  000904 (42000): SQL compilation error: error line 70 at position 8
  invalid identifier 'EXTRACTION_TIMESTAMP'
  compiled code at target\run\nba_dw_project\models\staging\stg_nba_stats.sql
[0m22:35:40.590458 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a0b1cce-7940-49a0-98bd-04527aab2230', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA860673D0>]}
[0m22:35:40.590458 [error] [Thread-1 (]: 1 of 3 ERROR creating sql view model MARMOT_FINAL_staging.stg_nba_stats ........ [[31mERROR[0m in 0.58s]
[0m22:35:40.590458 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m22:35:40.590458 [debug] [Thread-4 (]: Marking all children of 'model.nba_dw_project.stg_nba_stats' to be skipped because of status 'error'.  Reason: Database Error in model stg_nba_stats (models\staging\stg_nba_stats.sql)
  000904 (42000): SQL compilation error: error line 70 at position 8
  invalid identifier 'EXTRACTION_TIMESTAMP'
  compiled code at target\run\nba_dw_project\models\staging\stg_nba_stats.sql.
[0m22:35:40.590458 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m22:35:40.590458 [info ] [Thread-1 (]: 2 of 3 SKIP relation MARMOT_FINAL_marts.fact_player_season ..................... [[33mSKIP[0m]
[0m22:35:40.590458 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m22:35:40.590458 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m22:35:40.590458 [info ] [Thread-1 (]: 3 of 3 SKIP relation MARMOT_FINAL_marts.fact_player_season_advanced ............ [[33mSKIP[0m]
[0m22:35:40.590458 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m22:35:40.590458 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:35:40.590458 [debug] [MainThread]: Connection 'create_MLDS430_MARMOT_FINAL_marts' was left open.
[0m22:35:40.590458 [debug] [MainThread]: On create_MLDS430_MARMOT_FINAL_marts: Close
[0m22:35:40.774268 [debug] [MainThread]: Connection 'list_MLDS430_MARMOT_FINAL_marts' was left open.
[0m22:35:40.774268 [debug] [MainThread]: On list_MLDS430_MARMOT_FINAL_marts: Close
[0m22:35:40.922530 [debug] [MainThread]: Connection 'model.nba_dw_project.stg_nba_stats' was left open.
[0m22:35:40.922530 [debug] [MainThread]: On model.nba_dw_project.stg_nba_stats: Close
[0m22:35:41.071036 [info ] [MainThread]: 
[0m22:35:41.071036 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 3.41 seconds (3.41s).
[0m22:35:41.071036 [debug] [MainThread]: Command end result
[0m22:35:41.093805 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\manifest.json
[0m22:35:41.096805 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\semantic_manifest.json
[0m22:35:41.101346 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\run_results.json
[0m22:35:41.101346 [info ] [MainThread]: 
[0m22:35:41.101346 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:35:41.101346 [info ] [MainThread]: 
[0m22:35:41.101346 [error] [MainThread]: [31mFailure in model stg_nba_stats (models\staging\stg_nba_stats.sql)[0m
[0m22:35:41.101346 [error] [MainThread]:   Database Error in model stg_nba_stats (models\staging\stg_nba_stats.sql)
  000904 (42000): SQL compilation error: error line 70 at position 8
  invalid identifier 'EXTRACTION_TIMESTAMP'
  compiled code at target\run\nba_dw_project\models\staging\stg_nba_stats.sql
[0m22:35:41.101346 [info ] [MainThread]: 
[0m22:35:41.105738 [info ] [MainThread]:   compiled code at target\compiled\nba_dw_project\models\staging\stg_nba_stats.sql
[0m22:35:41.105738 [info ] [MainThread]: 
[0m22:35:41.105738 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=2 NO-OP=0 TOTAL=3
[0m22:35:41.107016 [debug] [MainThread]: Command `dbt run` failed at 22:35:41.107016 after 5.33 seconds
[0m22:35:41.108016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAFB891ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAFB892390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA8204F5D0>]}
[0m22:35:41.108016 [debug] [MainThread]: Flushing usage events
[0m22:35:41.214977 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:36:56.329355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372E41D050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372E41C550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372E41CF50>]}


============================== 22:36:56.329355 | 320388a2-0f2a-4619-8a7f-3066fe687042 ==============================
[0m22:36:56.329355 [info ] [MainThread]: Running with dbt=1.11.0-b4
[0m22:36:56.329355 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run', 'fail_fast': 'False', 'cache_selected_only': 'False', 'quiet': 'False', 'log_format': 'default', 'printer_width': '80', 'log_cache_events': 'False', 'introspect': 'True', 'indirect_selection': 'eager', 'warn_error': 'None', 'write_json': 'True', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': 'C:\\Users\\zeyuz\\.dbt', 'log_path': 'C:\\Users\\zeyuz\\OneDrive\\Desktop\\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\\DW Project End-to-End Pipeline\\dw_final_project\\include\\nba_dw_project\\logs', 'debug': 'False', 'empty': 'False', 'partial_parse': 'True', 'version_check': 'True', 'static_parser': 'True', 'use_colors': 'True', 'no_print': 'None'}
[0m22:36:56.765971 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m22:36:56.765971 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m22:36:56.765971 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m22:36:56.897173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372E425190>]}
[0m22:36:56.941256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372C456690>]}
[0m22:36:56.941256 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m22:36:57.128052 [debug] [MainThread]: checksum: 57e51233fb2305050a86c940b93938a4d3a51a7b95f45f76840a20ffa12695aa, vars: {}, profile: , target: , version: 1.11.0b4
[0m22:36:57.238928 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:36:57.238928 [debug] [MainThread]: Partial parsing: updated file: nba_dw_project://models\staging\stg_nba_stats.sql
[0m22:36:57.422078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372FB44B90>]}
[0m22:36:57.453591 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\manifest.json
[0m22:36:57.469555 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\semantic_manifest.json
[0m22:36:57.486140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372FDFD050>]}
[0m22:36:57.486140 [info ] [MainThread]: Found 3 models, 1 source, 494 macros
[0m22:36:57.486140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372FD42210>]}
[0m22:36:57.486140 [info ] [MainThread]: 
[0m22:36:57.486140 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:36:57.486140 [info ] [MainThread]: 
[0m22:36:57.486140 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:36:57.497434 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m22:36:57.638836 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m22:36:57.638836 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m22:36:57.638836 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:58.510062 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.881 seconds
[0m22:36:58.525228 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m22:36:58.527234 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m22:36:58.823352 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.297 seconds
[0m22:36:58.825358 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430_MARMOT_FINAL_marts'
[0m22:36:58.831930 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL_marts"
[0m22:36:58.831930 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL_marts: show objects in MLDS430.MARMOT_FINAL_marts
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL_marts"} */;
[0m22:36:58.831930 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:59.683838 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.855 seconds
[0m22:36:59.692696 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL_marts, now list_MLDS430_MARMOT_FINAL_staging)
[0m22:36:59.694704 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL_staging"
[0m22:36:59.694704 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL_staging: show objects in MLDS430.MARMOT_FINAL_staging
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL_staging"} */;
[0m22:36:59.811225 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.119 seconds
[0m22:36:59.816389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372FCD3450>]}
[0m22:36:59.816389 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m22:36:59.816389 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL_staging.stg_nba_stats ................. [RUN]
[0m22:36:59.816389 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.nba_dw_project.stg_nba_stats'
[0m22:36:59.816389 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m22:36:59.829011 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m22:36:59.830324 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m22:36:59.849039 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m22:36:59.849039 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m22:36:59.849039 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL_staging.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m22:36:59.849039 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:37:00.667905 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.811 seconds
[0m22:37:00.687193 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002373150F110>]}
[0m22:37:00.687193 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL_staging.stg_nba_stats ............ [[32mSUCCESS 1[0m in 0.87s]
[0m22:37:00.687193 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m22:37:00.687193 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m22:37:00.687193 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL_marts.fact_player_season ............. [RUN]
[0m22:37:00.687193 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m22:37:00.687193 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m22:37:00.699434 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m22:37:00.700067 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m22:37:00.814317 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m22:37:00.814317 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m22:37:00.814317 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL_marts.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL_staging.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m22:37:03.294952 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.480 seconds
[0m22:37:03.294952 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237315456D0>]}
[0m22:37:03.294952 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL_marts.fact_player_season ........ [[32mSUCCESS 1[0m in 2.61s]
[0m22:37:03.294952 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m22:37:03.294952 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m22:37:03.294952 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL_marts.fact_player_season_advanced .... [RUN]
[0m22:37:03.306897 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m22:37:03.307486 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m22:37:03.307486 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m22:37:03.307486 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m22:37:03.307486 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m22:37:03.307486 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m22:37:03.307486 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL_marts.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL_staging.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m22:37:04.905771 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.600 seconds
[0m22:37:04.905771 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '320388a2-0f2a-4619-8a7f-3066fe687042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023731572E10>]}
[0m22:37:04.905771 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL_marts.fact_player_season_advanced  [[32mSUCCESS 1[0m in 1.60s]
[0m22:37:04.905771 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m22:37:04.920798 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:37:04.920798 [debug] [MainThread]: Connection 'list_MLDS430' was left open.
[0m22:37:04.920798 [debug] [MainThread]: On list_MLDS430: Close
[0m22:37:05.078280 [debug] [MainThread]: Connection 'list_MLDS430_MARMOT_FINAL_staging' was left open.
[0m22:37:05.078280 [debug] [MainThread]: On list_MLDS430_MARMOT_FINAL_staging: Close
[0m22:37:05.244264 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m22:37:05.244264 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m22:37:05.388182 [info ] [MainThread]: 
[0m22:37:05.388182 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 7.90 seconds (7.90s).
[0m22:37:05.388182 [debug] [MainThread]: Command end result
[0m22:37:05.416493 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\manifest.json
[0m22:37:05.420987 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\semantic_manifest.json
[0m22:37:05.426641 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\run_results.json
[0m22:37:05.426641 [info ] [MainThread]: 
[0m22:37:05.427642 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:37:05.427642 [info ] [MainThread]: 
[0m22:37:05.428639 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m22:37:05.429756 [debug] [MainThread]: Command `dbt run` succeeded at 22:37:05.429756 after 9.16 seconds
[0m22:37:05.429756 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002372F898ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023726A72190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023726A72250>]}
[0m22:37:05.430756 [debug] [MainThread]: Flushing usage events
[0m22:37:05.556040 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:42:36.502303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A40B4150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A405C650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A405C7D0>]}


============================== 22:42:36.502303 | 91b4b397-f512-4b51-86fe-a851e134980c ==============================
[0m22:42:36.502303 [info ] [MainThread]: Running with dbt=1.11.0-b4
[0m22:42:36.502303 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'partial_parse': 'True', 'empty': 'False', 'introspect': 'True', 'printer_width': '80', 'fail_fast': 'False', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'profiles_dir': 'C:\\Users\\zeyuz\\.dbt', 'use_colors': 'True', 'version_check': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'log_path': 'C:\\Users\\zeyuz\\OneDrive\\Desktop\\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\\DW Project End-to-End Pipeline\\dw_final_project\\include\\nba_dw_project\\logs', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'cache_selected_only': 'False', 'target_path': 'None', 'no_print': 'None', 'warn_error': 'None', 'log_cache_events': 'False'}
[0m22:42:36.976334 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m22:42:36.977340 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m22:42:36.978012 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m22:42:37.115892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A4083B10>]}
[0m22:42:37.153749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A549BA90>]}
[0m22:42:37.153749 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m22:42:37.355744 [debug] [MainThread]: checksum: 57e51233fb2305050a86c940b93938a4d3a51a7b95f45f76840a20ffa12695aa, vars: {}, profile: , target: , version: 1.11.0b4
[0m22:42:37.434910 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m22:42:37.434910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A2090D90>]}
[0m22:42:38.245866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A5828AD0>]}
[0m22:42:38.290170 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\manifest.json
[0m22:42:38.290170 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\semantic_manifest.json
[0m22:42:38.306627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A5BBF910>]}
[0m22:42:38.306627 [info ] [MainThread]: Found 3 models, 1 source, 494 macros
[0m22:42:38.306627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A59F4890>]}
[0m22:42:38.306627 [info ] [MainThread]: 
[0m22:42:38.306627 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:42:38.306627 [info ] [MainThread]: 
[0m22:42:38.306627 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:42:38.321755 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m22:42:38.467940 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m22:42:38.468447 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m22:42:38.468447 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:42:39.510279 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 1.047 seconds
[0m22:42:39.510279 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430_MARMOT_FINAL'
[0m22:42:39.525355 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m22:42:39.525355 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m22:42:39.525355 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:42:39.978067 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.460 seconds
[0m22:42:39.990627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A57D3990>]}
[0m22:42:39.993894 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m22:42:39.993894 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m22:42:39.993894 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.nba_dw_project.stg_nba_stats'
[0m22:42:39.993894 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m22:42:40.004346 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m22:42:40.004924 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m22:42:40.023092 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m22:42:40.023092 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m22:42:40.023092 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m22:42:40.023092 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:42:40.791923 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.772 seconds
[0m22:42:40.807724 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A710FA10>]}
[0m22:42:40.807724 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.81s]
[0m22:42:40.823734 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m22:42:40.823734 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m22:42:40.823734 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m22:42:40.823734 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m22:42:40.823734 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m22:42:40.823734 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m22:42:40.823734 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m22:42:40.846284 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m22:42:40.849715 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m22:42:40.852002 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m22:42:42.883154 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.033 seconds
[0m22:42:42.883154 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A70A4690>]}
[0m22:42:42.883154 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.06s]
[0m22:42:42.883154 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m22:42:42.883154 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m22:42:42.883154 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m22:42:42.883154 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m22:42:42.883154 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m22:42:42.883154 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m22:42:42.896799 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m22:42:42.898835 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m22:42:42.900977 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m22:42:42.901405 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.11.0b4", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m22:42:44.811166 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.925 seconds
[0m22:42:44.827262 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '91b4b397-f512-4b51-86fe-a851e134980c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A7252650>]}
[0m22:42:44.827262 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.94s]
[0m22:42:44.827262 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m22:42:44.827262 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:42:44.827262 [debug] [MainThread]: Connection 'list_MLDS430' was left open.
[0m22:42:44.827262 [debug] [MainThread]: On list_MLDS430: Close
[0m22:42:45.007469 [debug] [MainThread]: Connection 'list_MLDS430_MARMOT_FINAL' was left open.
[0m22:42:45.007469 [debug] [MainThread]: On list_MLDS430_MARMOT_FINAL: Close
[0m22:42:45.153533 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m22:42:45.154532 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m22:42:45.288479 [info ] [MainThread]: 
[0m22:42:45.288479 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.98 seconds (6.98s).
[0m22:42:45.288479 [debug] [MainThread]: Command end result
[0m22:42:45.313384 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\manifest.json
[0m22:42:45.318261 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\semantic_manifest.json
[0m22:42:45.323831 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\zeyuz\OneDrive\Desktop\2025FA_MLDS_430-0_SEC20 Data Visualization and Warehousing\DW Project End-to-End Pipeline\dw_final_project\include\nba_dw_project\target\run_results.json
[0m22:42:45.323831 [info ] [MainThread]: 
[0m22:42:45.323831 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:42:45.328956 [info ] [MainThread]: 
[0m22:42:45.328956 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m22:42:45.328956 [debug] [MainThread]: Command `dbt run` succeeded at 22:42:45.328956 after 8.88 seconds
[0m22:42:45.328956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A40D2710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A40D25D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241A40D1F90>]}
[0m22:42:45.328956 [debug] [MainThread]: Flushing usage events
[0m22:42:45.478619 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m04:49:15.022451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba28495d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba2832dfa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba27b04dd0>]}


============================== 04:49:15.067746 | 6ea22594-5d4a-49ae-a29e-37a17a9f3c01 ==============================
[0m04:49:15.067746 [info ] [MainThread]: Running with dbt=1.10.15
[0m04:49:15.068382 [debug] [MainThread]: running dbt with arguments {'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'version_check': 'True', 'log_format': 'default', 'no_print': 'None', 'target_path': 'None', 'warn_error': 'None', 'indirect_selection': 'eager', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'invocation_command': 'dbt run --profiles-dir .', 'log_cache_events': 'False', 'write_json': 'True', 'printer_width': '80', 'partial_parse': 'True', 'profiles_dir': '.', 'use_experimental_parser': 'False', 'empty': 'False', 'debug': 'False', 'introspect': 'True', 'cache_selected_only': 'False', 'fail_fast': 'False', 'use_colors': 'True'}
[0m04:49:16.028975 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m04:49:16.029915 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m04:49:16.030476 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m04:49:16.257155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9f588e510>]}
[0m04:49:16.313453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba27ae3260>]}
[0m04:49:16.314664 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m04:49:16.417626 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m04:49:16.501246 [info ] [MainThread]: Unable to do partial parsing because of a version mismatch
[0m04:49:16.502040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9f4321700>]}
[0m04:49:17.769906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba28ff1c40>]}
[0m04:49:17.854002 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m04:49:17.859901 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m04:49:17.902130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9edfdb740>]}
[0m04:49:17.903285 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m04:49:17.904106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9f426b860>]}
[0m04:49:17.907168 [info ] [MainThread]: 
[0m04:49:17.908139 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m04:49:17.908768 [info ] [MainThread]: 
[0m04:49:17.909698 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m04:49:17.916212 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m04:49:17.967937 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m04:49:17.968886 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m04:49:17.969462 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:49:19.041496 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 1.072 seconds
[0m04:49:19.045849 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m04:49:19.059752 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m04:49:19.060480 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m04:49:19.599855 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.539 seconds
[0m04:49:19.603141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9f426b890>]}
[0m04:49:19.609176 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m04:49:19.610032 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m04:49:19.610739 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m04:49:19.611279 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m04:49:19.620086 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m04:49:19.626479 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m04:49:19.657748 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m04:49:19.668466 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m04:49:19.669470 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m04:49:20.089200 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.419 seconds
[0m04:49:20.111756 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba29a12d50>]}
[0m04:49:20.113070 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.50s]
[0m04:49:20.114128 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m04:49:20.115317 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m04:49:20.115881 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m04:49:20.116477 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m04:49:20.116938 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m04:49:20.120717 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m04:49:20.125976 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m04:49:20.150841 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m04:49:20.157921 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m04:49:20.158557 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m04:49:22.045163 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.886 seconds
[0m04:49:22.048026 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9ed0aa150>]}
[0m04:49:22.048861 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 1.93s]
[0m04:49:22.049628 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m04:49:22.050218 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m04:49:22.050729 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m04:49:22.051251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m04:49:22.051660 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m04:49:22.054920 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m04:49:22.059973 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m04:49:22.064533 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m04:49:22.071493 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m04:49:22.072666 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m04:49:23.791602 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.718 seconds
[0m04:49:23.794296 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ea22594-5d4a-49ae-a29e-37a17a9f3c01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9ec716b40>]}
[0m04:49:23.794930 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.74s]
[0m04:49:23.795682 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m04:49:23.797906 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:49:23.798519 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m04:49:23.798916 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m04:49:23.958470 [info ] [MainThread]: 
[0m04:49:23.959186 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.05 seconds (6.05s).
[0m04:49:23.960213 [debug] [MainThread]: Command end result
[0m04:49:23.992767 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m04:49:23.997679 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m04:49:24.006200 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m04:49:24.006805 [info ] [MainThread]: 
[0m04:49:24.007328 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:49:24.007850 [info ] [MainThread]: 
[0m04:49:24.008335 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m04:49:24.009556 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.047564, "process_in_blocks": "6056", "process_kernel_time": 1.371487, "process_mem_max_rss": "275576", "process_out_blocks": "16", "process_user_time": 4.965383}
[0m04:49:24.010130 [debug] [MainThread]: Command `dbt run` succeeded at 04:49:24.010043 after 9.05 seconds
[0m04:49:24.010580 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba2b6d7050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fba29706ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb9ed0b8350>]}
[0m04:49:24.011012 [debug] [MainThread]: Flushing usage events
[0m04:49:24.234710 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m04:52:22.620627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe4152a8b00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe4172bf290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe415129b80>]}


============================== 04:52:22.662054 | 6c3cb014-eb27-41c9-ac4e-df720699c922 ==============================
[0m04:52:22.662054 [info ] [MainThread]: Running with dbt=1.10.15
[0m04:52:22.662868 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'use_colors': 'True', 'quiet': 'False', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'invocation_command': 'dbt run --profiles-dir .', 'fail_fast': 'False', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '.', 'log_cache_events': 'False', 'warn_error': 'None', 'introspect': 'True', 'version_check': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'cache_selected_only': 'False', 'log_format': 'default', 'indirect_selection': 'eager', 'static_parser': 'True', 'target_path': 'None', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'printer_width': '80'}
[0m04:52:23.573983 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m04:52:23.574845 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m04:52:23.575460 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m04:52:23.767092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3de17ff50>]}
[0m04:52:23.829707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3dee6adb0>]}
[0m04:52:23.831253 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m04:52:23.935368 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m04:52:24.056757 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:52:24.057505 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:52:24.088342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3de198560>]}
[0m04:52:24.173586 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m04:52:24.178553 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m04:52:24.222184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3ddaa62a0>]}
[0m04:52:24.223024 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m04:52:24.223655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3dd8a38f0>]}
[0m04:52:24.225670 [info ] [MainThread]: 
[0m04:52:24.226421 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m04:52:24.226931 [info ] [MainThread]: 
[0m04:52:24.227641 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m04:52:24.232478 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m04:52:24.276137 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m04:52:24.277005 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m04:52:24.277629 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:52:25.227436 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.950 seconds
[0m04:52:25.232777 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m04:52:25.248673 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m04:52:25.249457 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m04:52:25.406108 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.156 seconds
[0m04:52:25.409265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe414675520>]}
[0m04:52:25.412416 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m04:52:25.413158 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m04:52:25.413854 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m04:52:25.414452 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m04:52:25.423542 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m04:52:25.430598 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m04:52:25.462939 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m04:52:25.476021 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m04:52:25.477109 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m04:52:25.851729 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.374 seconds
[0m04:52:25.878000 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe41702e4b0>]}
[0m04:52:25.879236 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.46s]
[0m04:52:25.880346 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m04:52:25.881686 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m04:52:25.882309 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m04:52:25.882985 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m04:52:25.883655 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m04:52:25.888211 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m04:52:25.894453 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m04:52:25.918601 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m04:52:25.926695 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m04:52:25.927611 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m04:52:27.622251 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.694 seconds
[0m04:52:27.624881 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3dca47b60>]}
[0m04:52:27.625913 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 1.74s]
[0m04:52:27.626736 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m04:52:27.627277 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m04:52:27.627861 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m04:52:27.628453 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m04:52:27.628875 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m04:52:27.632997 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m04:52:27.638201 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m04:52:27.738744 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m04:52:27.746132 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m04:52:27.746837 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m04:52:29.185745 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.438 seconds
[0m04:52:29.188517 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c3cb014-eb27-41c9-ac4e-df720699c922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3dc05e8a0>]}
[0m04:52:29.189224 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.56s]
[0m04:52:29.189972 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m04:52:29.191731 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:52:29.192177 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m04:52:29.192557 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m04:52:29.337577 [info ] [MainThread]: 
[0m04:52:29.338322 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 5.11 seconds (5.11s).
[0m04:52:29.339354 [debug] [MainThread]: Command end result
[0m04:52:29.372418 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m04:52:29.378506 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m04:52:29.387613 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m04:52:29.388236 [info ] [MainThread]: 
[0m04:52:29.388793 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:52:29.389265 [info ] [MainThread]: 
[0m04:52:29.389748 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m04:52:29.390916 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 6.8275976, "process_in_blocks": "0", "process_kernel_time": 1.318547, "process_mem_max_rss": "266296", "process_out_blocks": "16", "process_user_time": 3.66596}
[0m04:52:29.391473 [debug] [MainThread]: Command `dbt run` succeeded at 04:52:29.391384 after 6.83 seconds
[0m04:52:29.391982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3df7ac620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3dd8da450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3dd8da150>]}
[0m04:52:29.392546 [debug] [MainThread]: Flushing usage events
[0m04:52:29.588644 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m04:56:25.258353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15e518ec00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15e4812270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15e3f4d3a0>]}


============================== 04:56:25.313739 | d85d2a2e-d07c-47ca-b0af-df20aee90507 ==============================
[0m04:56:25.313739 [info ] [MainThread]: Running with dbt=1.10.15
[0m04:56:25.314609 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'empty': 'False', 'log_cache_events': 'False', 'partial_parse': 'True', 'version_check': 'True', 'invocation_command': 'dbt run --profiles-dir .', 'quiet': 'False', 'use_experimental_parser': 'False', 'debug': 'False', 'introspect': 'True', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'fail_fast': 'False', 'log_format': 'default', 'target_path': 'None', 'use_colors': 'True', 'indirect_selection': 'eager', 'static_parser': 'True', 'cache_selected_only': 'False', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'write_json': 'True', 'profiles_dir': '.'}
[0m04:56:26.319294 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m04:56:26.320303 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m04:56:26.321094 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m04:56:26.513521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15e3e10d10>]}
[0m04:56:26.575363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15adb42030>]}
[0m04:56:26.576673 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m04:56:26.680002 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m04:56:26.811532 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:56:26.812251 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:56:26.844316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ada36630>]}
[0m04:56:26.923274 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m04:56:26.927521 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m04:56:26.960874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ad076900>]}
[0m04:56:26.961576 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m04:56:26.962071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ad4052b0>]}
[0m04:56:26.964737 [info ] [MainThread]: 
[0m04:56:26.965629 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m04:56:26.966229 [info ] [MainThread]: 
[0m04:56:26.967029 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m04:56:26.972087 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m04:56:27.017001 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m04:56:27.017756 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m04:56:27.018291 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:56:28.030603 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 1.012 seconds
[0m04:56:28.035139 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m04:56:28.048390 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m04:56:28.049058 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m04:56:28.212631 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.163 seconds
[0m04:56:28.215570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ac23bc20>]}
[0m04:56:28.219223 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m04:56:28.220092 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m04:56:28.220786 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m04:56:28.221223 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m04:56:28.229470 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m04:56:28.234345 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m04:56:28.261389 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m04:56:28.273859 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m04:56:28.274919 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m04:56:28.638354 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.363 seconds
[0m04:56:28.659530 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15acef7080>]}
[0m04:56:28.660482 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.44s]
[0m04:56:28.661426 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m04:56:28.662880 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m04:56:28.663564 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m04:56:28.664214 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m04:56:28.664711 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m04:56:28.667923 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m04:56:28.672843 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m04:56:28.694534 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m04:56:28.701918 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m04:56:28.702542 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m04:56:30.240421 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.537 seconds
[0m04:56:30.243189 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ac08fb30>]}
[0m04:56:30.243923 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 1.58s]
[0m04:56:30.244715 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m04:56:30.245290 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m04:56:30.245835 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m04:56:30.246368 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m04:56:30.246876 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m04:56:30.250836 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m04:56:30.255761 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m04:56:30.357408 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m04:56:30.364604 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m04:56:30.365246 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m04:56:32.189609 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.824 seconds
[0m04:56:32.192391 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd85d2a2e-d07c-47ca-b0af-df20aee90507', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ac0d1640>]}
[0m04:56:32.193175 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.95s]
[0m04:56:32.193894 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m04:56:32.195549 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:56:32.196018 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m04:56:32.196404 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m04:56:32.347827 [info ] [MainThread]: 
[0m04:56:32.348557 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 5.38 seconds (5.38s).
[0m04:56:32.349612 [debug] [MainThread]: Command end result
[0m04:56:32.379559 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m04:56:32.383768 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m04:56:32.392144 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m04:56:32.392689 [info ] [MainThread]: 
[0m04:56:32.393184 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:56:32.393632 [info ] [MainThread]: 
[0m04:56:32.394119 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m04:56:32.395227 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.1992674, "process_in_blocks": "0", "process_kernel_time": 1.376314, "process_mem_max_rss": "266260", "process_out_blocks": "16", "process_user_time": 4.049157}
[0m04:56:32.395775 [debug] [MainThread]: Command `dbt run` succeeded at 04:56:32.395682 after 7.20 seconds
[0m04:56:32.396226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15e4f31a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ad2b6de0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f15ada62b70>]}
[0m04:56:32.396735 [debug] [MainThread]: Flushing usage events
[0m04:56:32.594933 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m05:13:15.080654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f569c831f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f569c831130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f569bfe3b60>]}


============================== 05:13:15.134749 | 770c2f22-854a-494b-aeb4-805b2065d8e0 ==============================
[0m05:13:15.134749 [info ] [MainThread]: Running with dbt=1.10.15
[0m05:13:15.135585 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'write_json': 'True', 'no_print': 'None', 'use_colors': 'True', 'target_path': 'None', 'indirect_selection': 'eager', 'debug': 'False', 'partial_parse': 'True', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir .', 'profiles_dir': '.', 'warn_error': 'None', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'fail_fast': 'False', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'printer_width': '80'}
[0m05:13:16.276260 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m05:13:16.277216 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m05:13:16.278223 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m05:13:16.723870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f566b78b890>]}
[0m05:13:16.785920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f566b7a84d0>]}
[0m05:13:16.787771 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m05:13:16.899878 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m05:13:17.062924 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:13:17.063612 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:13:17.098789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5668a9a270>]}
[0m05:13:17.179812 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:13:17.185280 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:13:17.224092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5668a26de0>]}
[0m05:13:17.224758 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m05:13:17.225212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5668875c40>]}
[0m05:13:17.227029 [info ] [MainThread]: 
[0m05:13:17.227802 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m05:13:17.228409 [info ] [MainThread]: 
[0m05:13:17.229272 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m05:13:17.234888 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m05:13:17.286128 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m05:13:17.286918 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m05:13:17.287489 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:13:18.253530 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.966 seconds
[0m05:13:18.259113 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m05:13:18.275209 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m05:13:18.275964 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m05:13:18.433301 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.157 seconds
[0m05:13:18.436377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56686aaba0>]}
[0m05:13:18.441254 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m05:13:18.442057 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m05:13:18.442736 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m05:13:18.443163 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m05:13:18.451549 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m05:13:18.457519 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m05:13:18.486475 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m05:13:18.497648 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m05:13:18.498820 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m05:13:18.930341 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.431 seconds
[0m05:13:18.956314 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5668188f80>]}
[0m05:13:18.957550 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.51s]
[0m05:13:18.958419 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m05:13:18.959748 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m05:13:18.960434 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m05:13:18.961145 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m05:13:18.961720 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m05:13:18.966207 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m05:13:18.972482 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m05:13:18.999060 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m05:13:19.007185 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m05:13:19.008035 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m05:13:21.437906 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.429 seconds
[0m05:13:21.440844 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f566808c2c0>]}
[0m05:13:21.441642 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.48s]
[0m05:13:21.442403 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m05:13:21.442912 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m05:13:21.443465 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m05:13:21.444045 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m05:13:21.444570 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m05:13:21.450023 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:13:21.457434 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m05:13:21.579902 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:13:21.586399 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m05:13:21.587363 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m05:13:23.541683 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.953 seconds
[0m05:13:23.545980 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '770c2f22-854a-494b-aeb4-805b2065d8e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f566808d430>]}
[0m05:13:23.547949 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 2.10s]
[0m05:13:23.549303 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m05:13:23.551946 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:13:23.552888 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m05:13:23.553967 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m05:13:23.709703 [info ] [MainThread]: 
[0m05:13:23.710459 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.48 seconds (6.48s).
[0m05:13:23.711688 [debug] [MainThread]: Command end result
[0m05:13:23.750039 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:13:23.755778 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:13:23.766008 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m05:13:23.766667 [info ] [MainThread]: 
[0m05:13:23.767280 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:13:23.767781 [info ] [MainThread]: 
[0m05:13:23.768303 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m05:13:23.770500 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.757557, "process_in_blocks": "62128", "process_kernel_time": 1.433164, "process_mem_max_rss": "265840", "process_out_blocks": "16", "process_user_time": 4.160157}
[0m05:13:23.771813 [debug] [MainThread]: Command `dbt run` succeeded at 05:13:23.771657 after 8.76 seconds
[0m05:13:23.772568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f569bbb1f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f569c64d010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f569c340980>]}
[0m05:13:23.773190 [debug] [MainThread]: Flushing usage events
[0m05:13:24.001399 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m05:15:40.538567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd02920740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd01e90830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd02053380>]}


============================== 05:15:40.581741 | d314aef5-709a-4336-994a-748f9d42cafd ==============================
[0m05:15:40.581741 [info ] [MainThread]: Running with dbt=1.10.15
[0m05:15:40.582335 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'target_path': 'None', 'introspect': 'True', 'empty': 'False', 'invocation_command': 'dbt run --profiles-dir .', 'log_format': 'default', 'warn_error': 'None', 'use_colors': 'True', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '.', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'cache_selected_only': 'False', 'write_json': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'log_cache_events': 'False', 'partial_parse': 'True', 'version_check': 'True', 'use_experimental_parser': 'False', 'static_parser': 'True', 'printer_width': '80'}
[0m05:15:41.570191 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m05:15:41.571042 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m05:15:41.571780 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m05:15:41.823692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdccb2b21b0>]}
[0m05:15:41.883419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdccbc595e0>]}
[0m05:15:41.885325 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m05:15:41.992997 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m05:15:42.182540 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:15:42.183371 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:15:42.217529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdccaa51f10>]}
[0m05:15:42.304819 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:15:42.310501 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:15:42.352323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdcca9dc410>]}
[0m05:15:42.353143 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m05:15:42.353768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdcca7780b0>]}
[0m05:15:42.356103 [info ] [MainThread]: 
[0m05:15:42.356784 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m05:15:42.357364 [info ] [MainThread]: 
[0m05:15:42.358141 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m05:15:42.363340 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m05:15:42.412793 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m05:15:42.413669 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m05:15:42.414274 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:15:43.372710 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.958 seconds
[0m05:15:43.377770 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m05:15:43.393509 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m05:15:43.394411 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m05:15:43.516028 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.121 seconds
[0m05:15:43.519662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdcc9b062d0>]}
[0m05:15:43.524734 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m05:15:43.525713 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m05:15:43.526427 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m05:15:43.526925 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m05:15:43.535477 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m05:15:43.541991 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m05:15:43.578207 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m05:15:43.590740 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m05:15:43.591872 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m05:15:43.940279 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.347 seconds
[0m05:15:43.966391 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd03fb6780>]}
[0m05:15:43.967653 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.44s]
[0m05:15:43.968633 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m05:15:43.970046 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m05:15:43.970560 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m05:15:43.971128 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m05:15:43.971535 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m05:15:43.975473 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m05:15:43.981083 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m05:15:44.008908 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m05:15:44.016686 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m05:15:44.017663 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m05:15:45.588545 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.570 seconds
[0m05:15:45.591377 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdcbbf5c1a0>]}
[0m05:15:45.592348 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 1.62s]
[0m05:15:45.593206 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m05:15:45.593882 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m05:15:45.594474 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m05:15:45.595060 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m05:15:45.595505 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m05:15:45.600293 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:15:45.606882 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m05:15:45.727577 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:15:45.734751 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m05:15:45.735569 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m05:15:48.232764 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.496 seconds
[0m05:15:48.235767 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd314aef5-709a-4336-994a-748f9d42cafd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdcbbf5d850>]}
[0m05:15:48.236775 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 2.64s]
[0m05:15:48.237505 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m05:15:48.239582 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:15:48.240196 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m05:15:48.240773 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m05:15:48.416322 [info ] [MainThread]: 
[0m05:15:48.417112 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.06 seconds (6.06s).
[0m05:15:48.418135 [debug] [MainThread]: Command end result
[0m05:15:48.454454 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:15:48.460006 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:15:48.468763 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m05:15:48.469590 [info ] [MainThread]: 
[0m05:15:48.470373 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:15:48.470943 [info ] [MainThread]: 
[0m05:15:48.471494 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m05:15:48.472750 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.9964643, "process_in_blocks": "32312", "process_kernel_time": 1.372144, "process_mem_max_rss": "262972", "process_out_blocks": "16", "process_user_time": 4.096254}
[0m05:15:48.473609 [debug] [MainThread]: Command `dbt run` succeeded at 05:15:48.473507 after 8.00 seconds
[0m05:15:48.474229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd01e05d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd01e06f00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdccb33eae0>]}
[0m05:15:48.474951 [debug] [MainThread]: Flushing usage events
[0m05:15:48.683613 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m05:22:55.265237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c2240920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c1b48aa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c17b4860>]}


============================== 05:22:55.306434 | 360eb6ae-3aa7-4c6b-9842-93cd703f6f4f ==============================
[0m05:22:55.306434 [info ] [MainThread]: Running with dbt=1.10.15
[0m05:22:55.307368 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'empty': 'False', 'static_parser': 'True', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'version_check': 'True', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'no_print': 'None', 'target_path': 'None', 'quiet': 'False', 'profiles_dir': '.', 'use_experimental_parser': 'False', 'printer_width': '80', 'warn_error': 'None', 'log_format': 'default', 'use_colors': 'True', 'invocation_command': 'dbt run --profiles-dir .', 'fail_fast': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m05:22:56.243841 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m05:22:56.244726 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m05:22:56.245316 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m05:22:56.421246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c3840c20>]}
[0m05:22:56.481135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f698ac364b0>]}
[0m05:22:56.482541 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m05:22:56.584912 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m05:22:56.712080 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:22:56.712783 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:22:56.744333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f698a4cc980>]}
[0m05:22:56.825142 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:22:56.829534 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:22:56.868111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f698a2878f0>]}
[0m05:22:56.868941 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m05:22:56.869602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f698a4cfaa0>]}
[0m05:22:56.871852 [info ] [MainThread]: 
[0m05:22:56.872713 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m05:22:56.873380 [info ] [MainThread]: 
[0m05:22:56.874216 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m05:22:56.879488 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m05:22:56.924065 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m05:22:56.924928 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m05:22:56.925389 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:22:57.803419 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.878 seconds
[0m05:22:57.807929 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m05:22:57.822123 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m05:22:57.823139 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m05:22:58.067218 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.243 seconds
[0m05:22:58.070385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f698a7131d0>]}
[0m05:22:58.074119 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m05:22:58.074953 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m05:22:58.075514 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m05:22:58.075906 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m05:22:58.084040 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m05:22:58.087973 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m05:22:58.119472 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m05:22:58.129590 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m05:22:58.130501 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m05:22:58.625107 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.493 seconds
[0m05:22:58.650167 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c37f65a0>]}
[0m05:22:58.651151 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.57s]
[0m05:22:58.651873 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m05:22:58.653109 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m05:22:58.653655 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m05:22:58.654212 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m05:22:58.654653 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m05:22:58.658313 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m05:22:58.662092 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m05:22:58.686580 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m05:22:58.693176 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m05:22:58.693777 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m05:23:00.758145 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.064 seconds
[0m05:23:00.760660 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69892cc4d0>]}
[0m05:23:00.761309 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.11s]
[0m05:23:00.761927 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m05:23:00.762387 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m05:23:00.762888 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m05:23:00.763372 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m05:23:00.763777 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m05:23:00.768571 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:23:00.772690 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m05:23:00.876741 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:23:00.882368 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m05:23:00.883115 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m05:23:02.915078 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.033 seconds
[0m05:23:02.917789 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '360eb6ae-3aa7-4c6b-9842-93cd703f6f4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69892cd040>]}
[0m05:23:02.918625 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 2.15s]
[0m05:23:02.919278 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m05:23:02.921012 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:23:02.921821 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m05:23:02.922415 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m05:23:03.115704 [info ] [MainThread]: 
[0m05:23:03.116429 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.24 seconds (6.24s).
[0m05:23:03.117377 [debug] [MainThread]: Command end result
[0m05:23:03.149335 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:23:03.153645 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:23:03.162305 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m05:23:03.162905 [info ] [MainThread]: 
[0m05:23:03.163785 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:23:03.164485 [info ] [MainThread]: 
[0m05:23:03.165060 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m05:23:03.166188 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.961567, "process_in_blocks": "0", "process_kernel_time": 1.469091, "process_mem_max_rss": "266884", "process_out_blocks": "16", "process_user_time": 3.83155}
[0m05:23:03.166741 [debug] [MainThread]: Command `dbt run` succeeded at 05:23:03.166650 after 7.96 seconds
[0m05:23:03.167209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c10b9eb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69920b6ba0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f698a285970>]}
[0m05:23:03.167658 [debug] [MainThread]: Flushing usage events
[0m05:23:03.353207 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m05:33:40.149621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26689be450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2669d67230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f266883ab40>]}


============================== 05:33:40.195197 | 14d2d4c7-4d1f-49ce-9248-b4227deb4852 ==============================
[0m05:33:40.195197 [info ] [MainThread]: Running with dbt=1.10.15
[0m05:33:40.195938 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'write_json': 'True', 'fail_fast': 'False', 'static_parser': 'True', 'empty': 'False', 'printer_width': '80', 'no_print': 'None', 'log_cache_events': 'False', 'use_colors': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir .', 'quiet': 'False', 'version_check': 'True', 'debug': 'False', 'profiles_dir': '.', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'introspect': 'True', 'indirect_selection': 'eager', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'partial_parse': 'True'}
[0m05:33:41.226436 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m05:33:41.227284 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m05:33:41.227679 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m05:33:41.402342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f263503ba40>]}
[0m05:33:41.459296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2667c0d4f0>]}
[0m05:33:41.460640 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m05:33:41.561757 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m05:33:41.691629 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:33:41.692496 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:33:41.723673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2634c52e40>]}
[0m05:33:41.800137 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:33:41.805064 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:33:41.839911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26348037d0>]}
[0m05:33:41.840711 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m05:33:41.841342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2634accaa0>]}
[0m05:33:41.843565 [info ] [MainThread]: 
[0m05:33:41.844380 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m05:33:41.844873 [info ] [MainThread]: 
[0m05:33:41.845657 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m05:33:41.851941 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m05:33:41.893545 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m05:33:41.894248 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m05:33:41.894683 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:33:42.891982 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.997 seconds
[0m05:33:42.897135 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m05:33:42.911492 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m05:33:42.912213 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m05:33:43.028642 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.116 seconds
[0m05:33:43.031746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2634f9c4d0>]}
[0m05:33:43.034601 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m05:33:43.035510 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m05:33:43.036166 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m05:33:43.036642 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m05:33:43.045352 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m05:33:43.050125 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m05:33:43.085354 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m05:33:43.095691 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m05:33:43.097006 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m05:33:43.448058 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.350 seconds
[0m05:33:43.472014 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f266a052750>]}
[0m05:33:43.473158 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.44s]
[0m05:33:43.474120 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m05:33:43.475627 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m05:33:43.476358 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m05:33:43.477045 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m05:33:43.477531 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m05:33:43.480881 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m05:33:43.486807 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m05:33:43.510743 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m05:33:43.517964 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m05:33:43.518800 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m05:33:45.215303 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.696 seconds
[0m05:33:45.218371 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26340f0080>]}
[0m05:33:45.219389 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 1.74s]
[0m05:33:45.220139 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m05:33:45.220674 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m05:33:45.221273 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m05:33:45.221857 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m05:33:45.222332 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m05:33:45.227487 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:33:45.233492 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m05:33:45.343950 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m05:33:45.352047 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m05:33:45.352945 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m05:33:47.142842 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.789 seconds
[0m05:33:47.145844 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '14d2d4c7-4d1f-49ce-9248-b4227deb4852', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2634103650>]}
[0m05:33:47.146641 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.92s]
[0m05:33:47.147389 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m05:33:47.148893 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:33:47.149254 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m05:33:47.149642 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m05:33:47.315696 [info ] [MainThread]: 
[0m05:33:47.316479 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 5.47 seconds (5.47s).
[0m05:33:47.317450 [debug] [MainThread]: Command end result
[0m05:33:47.347808 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m05:33:47.352057 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m05:33:47.360745 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m05:33:47.361349 [info ] [MainThread]: 
[0m05:33:47.361861 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:33:47.362323 [info ] [MainThread]: 
[0m05:33:47.362789 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m05:33:47.363878 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.273803, "process_in_blocks": "0", "process_kernel_time": 1.347003, "process_mem_max_rss": "267212", "process_out_blocks": "16", "process_user_time": 3.901319}
[0m05:33:47.364397 [debug] [MainThread]: Command `dbt run` succeeded at 05:33:47.364309 after 7.27 seconds
[0m05:33:47.364851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26680780b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f266876ea20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2668760f80>]}
[0m05:33:47.365247 [debug] [MainThread]: Flushing usage events
[0m05:33:47.574959 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:33:19.030659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b303ccbf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b300ad130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b301512b0>]}


============================== 20:33:19.088814 | 8fb4ab2e-2c11-43d1-b198-48e500f759bd ==============================
[0m20:33:19.088814 [info ] [MainThread]: Running with dbt=1.10.15
[0m20:33:19.090994 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'debug': 'False', 'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'profiles_dir': '.', 'warn_error': 'None', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'use_experimental_parser': 'False', 'introspect': 'True', 'empty': 'False', 'version_check': 'True', 'no_print': 'None', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'partial_parse': 'True', 'use_colors': 'True', 'static_parser': 'True', 'write_json': 'True', 'fail_fast': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir .', 'quiet': 'False', 'target_path': 'None'}
[0m20:33:20.518036 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m20:33:20.518808 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m20:33:20.519251 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m20:33:20.830718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b2faf61e0>]}
[0m20:33:20.892629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b2f753c80>]}
[0m20:33:20.894719 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m20:33:21.023541 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m20:33:21.327164 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:33:21.328241 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:33:21.374239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9afd7bef00>]}
[0m20:33:21.476020 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m20:33:21.482581 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m20:33:21.531023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9afc4e53a0>]}
[0m20:33:21.531870 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m20:33:21.532840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9afc2c21b0>]}
[0m20:33:21.535129 [info ] [MainThread]: 
[0m20:33:21.536069 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:33:21.536747 [info ] [MainThread]: 
[0m20:33:21.537653 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:33:21.543735 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m20:33:21.614016 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m20:33:21.614937 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m20:33:21.615542 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:33:22.604149 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.989 seconds
[0m20:33:22.609598 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m20:33:22.627291 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m20:33:22.628201 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m20:33:22.852729 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.224 seconds
[0m20:33:22.856633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9afc11ed50>]}
[0m20:33:22.862836 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m20:33:22.863876 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m20:33:22.865450 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m20:33:22.866440 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m20:33:22.876919 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m20:33:22.885267 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m20:33:22.921550 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m20:33:22.934634 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m20:33:22.935604 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m20:33:23.440645 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.504 seconds
[0m20:33:23.469268 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b31a7a660>]}
[0m20:33:23.470890 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.60s]
[0m20:33:23.471677 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m20:33:23.473103 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m20:33:23.474009 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m20:33:23.474990 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m20:33:23.475657 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m20:33:23.480407 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m20:33:23.487647 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m20:33:23.517878 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m20:33:23.527943 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m20:33:23.528944 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m20:33:25.828996 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.299 seconds
[0m20:33:25.832585 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9af5a44230>]}
[0m20:33:25.834189 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.36s]
[0m20:33:25.836140 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m20:33:25.837549 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m20:33:25.839119 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m20:33:25.840199 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m20:33:25.841052 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m20:33:25.849389 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m20:33:25.858787 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m20:33:26.030337 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m20:33:26.040717 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m20:33:26.042304 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m20:33:28.314809 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.271 seconds
[0m20:33:28.317541 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fb4ab2e-2c11-43d1-b198-48e500f759bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9af5a44230>]}
[0m20:33:28.318273 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 2.48s]
[0m20:33:28.319236 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m20:33:28.320997 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:33:28.321423 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m20:33:28.321838 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m20:33:28.560229 [info ] [MainThread]: 
[0m20:33:28.561214 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 7.02 seconds (7.02s).
[0m20:33:28.562478 [debug] [MainThread]: Command end result
[0m20:33:28.597062 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m20:33:28.601851 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m20:33:28.610916 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m20:33:28.611591 [info ] [MainThread]: 
[0m20:33:28.612153 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:33:28.612636 [info ] [MainThread]: 
[0m20:33:28.613110 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m20:33:28.614717 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.732509, "process_in_blocks": "62592", "process_kernel_time": 1.564349, "process_mem_max_rss": "263932", "process_out_blocks": "16", "process_user_time": 5.161358}
[0m20:33:28.615406 [debug] [MainThread]: Command `dbt run` succeeded at 20:33:28.615289 after 9.73 seconds
[0m20:33:28.616021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9afc684170>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b2fe34830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9b303b3740>]}
[0m20:33:28.616570 [debug] [MainThread]: Flushing usage events
[0m20:33:28.802456 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:59:39.339221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc7164908f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc717d2b2f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc7161fb1d0>]}


============================== 20:59:39.383486 | 147d2465-f1e6-40f2-9b36-4ddb46e3e1cb ==============================
[0m20:59:39.383486 [info ] [MainThread]: Running with dbt=1.10.15
[0m20:59:39.384271 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run --profiles-dir .', 'quiet': 'False', 'target_path': 'None', 'partial_parse': 'True', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'static_parser': 'True', 'no_print': 'None', 'empty': 'False', 'debug': 'False', 'indirect_selection': 'eager', 'profiles_dir': '.', 'use_experimental_parser': 'False', 'fail_fast': 'False', 'log_format': 'default', 'printer_width': '80', 'version_check': 'True', 'warn_error': 'None', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'use_colors': 'True'}
[0m20:59:40.331771 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m20:59:40.332712 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m20:59:40.333422 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m20:59:40.570339 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc715b02e10>]}
[0m20:59:40.627347 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6e4842ae0>]}
[0m20:59:40.629295 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m20:59:40.733744 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m20:59:40.917797 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:59:40.918625 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:59:40.950253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6de5a97f0>]}
[0m20:59:41.028805 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m20:59:41.034568 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m20:59:41.077087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6de379940>]}
[0m20:59:41.077820 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m20:59:41.078403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6e481fe00>]}
[0m20:59:41.080359 [info ] [MainThread]: 
[0m20:59:41.081048 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:59:41.081622 [info ] [MainThread]: 
[0m20:59:41.082855 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:59:41.088314 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m20:59:41.133895 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m20:59:41.134712 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m20:59:41.135126 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:59:42.088383 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.953 seconds
[0m20:59:42.093190 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m20:59:42.107492 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m20:59:42.108492 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m20:59:42.298595 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.189 seconds
[0m20:59:42.302098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6dd7deba0>]}
[0m20:59:42.307563 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m20:59:42.308738 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m20:59:42.309565 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m20:59:42.310134 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m20:59:42.318997 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m20:59:42.325494 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m20:59:42.357230 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m20:59:42.368133 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m20:59:42.369191 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m20:59:42.923374 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.554 seconds
[0m20:59:42.948015 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc7163c3410>]}
[0m20:59:42.949453 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.64s]
[0m20:59:42.950362 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m20:59:42.951564 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m20:59:42.952172 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m20:59:42.952748 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m20:59:42.953225 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m20:59:42.956661 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m20:59:42.961945 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m20:59:42.988819 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m20:59:42.996680 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m20:59:42.997404 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m20:59:45.291871 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.294 seconds
[0m20:59:45.295062 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6dd3d0380>]}
[0m20:59:45.295782 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.34s]
[0m20:59:45.296545 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m20:59:45.297136 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m20:59:45.297675 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m20:59:45.298172 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m20:59:45.298705 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m20:59:45.303993 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m20:59:45.309819 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m20:59:45.423266 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m20:59:45.430393 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m20:59:45.431209 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m20:59:46.959562 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.528 seconds
[0m20:59:46.962083 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '147d2465-f1e6-40f2-9b36-4ddb46e3e1cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc6dd3d0d70>]}
[0m20:59:46.962766 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.66s]
[0m20:59:46.963566 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m20:59:46.965915 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:59:46.966541 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m20:59:46.966954 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m20:59:47.324909 [info ] [MainThread]: 
[0m20:59:47.325652 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.24 seconds (6.24s).
[0m20:59:47.326663 [debug] [MainThread]: Command end result
[0m20:59:47.356717 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m20:59:47.361506 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m20:59:47.369858 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m20:59:47.370518 [info ] [MainThread]: 
[0m20:59:47.371222 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:59:47.371743 [info ] [MainThread]: 
[0m20:59:47.372272 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m20:59:47.373366 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.095462, "process_in_blocks": "32480", "process_kernel_time": 1.188187, "process_mem_max_rss": "265444", "process_out_blocks": "16", "process_user_time": 4.031712}
[0m20:59:47.374073 [debug] [MainThread]: Command `dbt run` succeeded at 20:59:47.373899 after 8.10 seconds
[0m20:59:47.374878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc715b8cc50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc7162358e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc715b38140>]}
[0m20:59:47.375486 [debug] [MainThread]: Flushing usage events
[0m20:59:47.626793 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:02:57.868577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d399540b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d39940c80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d379dd4c0>]}


============================== 21:02:57.910168 | 0fe1e732-19e3-4428-9b8c-f8f8d808f12f ==============================
[0m21:02:57.910168 [info ] [MainThread]: Running with dbt=1.10.15
[0m21:02:57.911280 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'invocation_command': 'dbt run --profiles-dir .', 'version_check': 'True', 'log_cache_events': 'False', 'debug': 'False', 'cache_selected_only': 'False', 'warn_error': 'None', 'printer_width': '80', 'indirect_selection': 'eager', 'profiles_dir': '.', 'partial_parse': 'True', 'no_print': 'None', 'write_json': 'True', 'static_parser': 'True', 'quiet': 'False', 'log_format': 'default', 'target_path': 'None', 'use_colors': 'True', 'fail_fast': 'False', 'introspect': 'True', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs'}
[0m21:02:58.870959 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m21:02:58.871804 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m21:02:58.872263 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m21:02:59.045493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d0450e2a0>]}
[0m21:02:59.101927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d04dc8560>]}
[0m21:02:59.103390 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m21:02:59.203980 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m21:02:59.324566 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:02:59.325408 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:02:59.358355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d04773e30>]}
[0m21:02:59.435306 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:02:59.439648 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:02:59.473298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d040b4950>]}
[0m21:02:59.474112 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m21:02:59.474693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d05af3350>]}
[0m21:02:59.476560 [info ] [MainThread]: 
[0m21:02:59.477280 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:02:59.477912 [info ] [MainThread]: 
[0m21:02:59.478653 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:02:59.482962 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m21:02:59.521396 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m21:02:59.522127 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m21:02:59.522617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:03:00.442609 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.920 seconds
[0m21:03:00.447184 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m21:03:00.460882 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m21:03:00.461520 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m21:03:00.608917 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.147 seconds
[0m21:03:00.612091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5cff3c1af0>]}
[0m21:03:00.615684 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m21:03:00.616368 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m21:03:00.616986 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m21:03:00.617557 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m21:03:00.625792 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m21:03:00.631113 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m21:03:00.659594 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m21:03:00.670714 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m21:03:00.671574 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m21:03:01.151380 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.479 seconds
[0m21:03:01.176410 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5cff12a060>]}
[0m21:03:01.177925 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.56s]
[0m21:03:01.179136 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m21:03:01.180607 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m21:03:01.181267 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m21:03:01.181896 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m21:03:01.182411 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m21:03:01.186374 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m21:03:01.191733 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m21:03:01.216632 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m21:03:01.224503 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m21:03:01.225247 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m21:03:03.352563 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.127 seconds
[0m21:03:03.355288 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5cff07f740>]}
[0m21:03:03.355996 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.17s]
[0m21:03:03.356728 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m21:03:03.357305 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m21:03:03.357821 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m21:03:03.358338 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m21:03:03.358746 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m21:03:03.363081 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:03:03.368115 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m21:03:03.471015 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:03:03.477828 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m21:03:03.478637 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m21:03:05.662148 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.183 seconds
[0m21:03:05.664698 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0fe1e732-19e3-4428-9b8c-f8f8d808f12f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5cfd714950>]}
[0m21:03:05.665390 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 2.31s]
[0m21:03:05.666090 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m21:03:05.667675 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:03:05.668074 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m21:03:05.668445 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m21:03:05.914772 [info ] [MainThread]: 
[0m21:03:05.915533 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.44 seconds (6.44s).
[0m21:03:05.916491 [debug] [MainThread]: Command end result
[0m21:03:05.947409 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:03:05.951928 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:03:05.960248 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m21:03:05.960979 [info ] [MainThread]: 
[0m21:03:05.961681 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:03:05.962291 [info ] [MainThread]: 
[0m21:03:05.962790 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m21:03:05.963876 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.151129, "process_in_blocks": "0", "process_kernel_time": 1.259401, "process_mem_max_rss": "266656", "process_out_blocks": "16", "process_user_time": 3.858166}
[0m21:03:05.964404 [debug] [MainThread]: Command `dbt run` succeeded at 21:03:05.964319 after 8.15 seconds
[0m21:03:05.964836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d379dd4c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d37cd0920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5d37cd1970>]}
[0m21:03:05.965291 [debug] [MainThread]: Flushing usage events
[0m21:03:06.126866 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:06:43.111517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff86e32420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff86dfac30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff864b9d00>]}


============================== 21:06:43.155195 | f30bd590-268d-488d-a0bb-a773eea678eb ==============================
[0m21:06:43.155195 [info ] [MainThread]: Running with dbt=1.10.15
[0m21:06:43.155962 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'printer_width': '80', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'log_format': 'default', 'warn_error': 'None', 'use_colors': 'True', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'indirect_selection': 'eager', 'write_json': 'True', 'target_path': 'None', 'partial_parse': 'True', 'quiet': 'False', 'use_experimental_parser': 'False', 'introspect': 'True', 'debug': 'False', 'invocation_command': 'dbt run --profiles-dir .', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'fail_fast': 'False', 'profiles_dir': '.', 'version_check': 'True', 'static_parser': 'True', 'cache_selected_only': 'False'}
[0m21:06:44.155983 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m21:06:44.156856 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m21:06:44.157499 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m21:06:44.333278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff56f75790>]}
[0m21:06:44.390937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff86cce180>]}
[0m21:06:44.392248 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m21:06:44.494044 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m21:06:44.623627 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:06:44.624366 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:06:44.656007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff4ef552e0>]}
[0m21:06:44.731275 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:06:44.735901 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:06:44.769791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff4ed23dd0>]}
[0m21:06:44.770511 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m21:06:44.770987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff4ef57e00>]}
[0m21:06:44.772759 [info ] [MainThread]: 
[0m21:06:44.773239 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:06:44.773698 [info ] [MainThread]: 
[0m21:06:44.774382 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:06:44.779298 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m21:06:44.820214 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m21:06:44.820922 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m21:06:44.821333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:06:45.731496 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.910 seconds
[0m21:06:45.736231 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m21:06:45.749945 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m21:06:45.750725 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m21:06:45.922230 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.171 seconds
[0m21:06:45.925341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff4edc99d0>]}
[0m21:06:45.928423 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m21:06:45.929298 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m21:06:45.929955 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m21:06:45.930469 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m21:06:45.940167 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m21:06:45.946100 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m21:06:45.976928 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m21:06:45.988153 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m21:06:45.989040 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m21:06:46.386531 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.397 seconds
[0m21:06:46.409430 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff884ca510>]}
[0m21:06:46.410582 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.48s]
[0m21:06:46.411320 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m21:06:46.412422 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m21:06:46.412916 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m21:06:46.413436 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m21:06:46.413852 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m21:06:46.416972 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m21:06:46.422471 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m21:06:46.446408 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m21:06:46.453413 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m21:06:46.454055 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m21:06:48.675507 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.221 seconds
[0m21:06:48.678729 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff4de35d00>]}
[0m21:06:48.679544 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.27s]
[0m21:06:48.680304 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m21:06:48.680899 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m21:06:48.681487 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m21:06:48.682000 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m21:06:48.682425 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m21:06:48.686906 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:06:48.691945 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m21:06:48.794154 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:06:48.800783 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m21:06:48.801595 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m21:06:50.620676 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.818 seconds
[0m21:06:50.623219 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f30bd590-268d-488d-a0bb-a773eea678eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff4dd9e5d0>]}
[0m21:06:50.624009 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.94s]
[0m21:06:50.624869 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m21:06:50.626630 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:06:50.627376 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m21:06:50.627794 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m21:06:50.853240 [info ] [MainThread]: 
[0m21:06:50.853966 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.08 seconds (6.08s).
[0m21:06:50.854900 [debug] [MainThread]: Command end result
[0m21:06:50.886110 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:06:50.890276 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:06:50.899308 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m21:06:50.899852 [info ] [MainThread]: 
[0m21:06:50.900373 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:06:50.900846 [info ] [MainThread]: 
[0m21:06:50.901437 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m21:06:50.902810 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.8509045, "process_in_blocks": "0", "process_kernel_time": 1.275539, "process_mem_max_rss": "265016", "process_out_blocks": "16", "process_user_time": 3.967227}
[0m21:06:50.903469 [debug] [MainThread]: Command `dbt run` succeeded at 21:06:50.903370 after 7.85 seconds
[0m21:06:50.903948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff879a85c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff864b9d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7eff85c30350>]}
[0m21:06:50.904426 [debug] [MainThread]: Flushing usage events
[0m21:06:51.072577 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:10:07.803311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c5478d70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c704fbf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c53eae40>]}


============================== 21:10:07.846324 | 785629c3-e6da-4a0b-bdce-05e9bdfbc20f ==============================
[0m21:10:07.846324 [info ] [MainThread]: Running with dbt=1.10.15
[0m21:10:07.846999 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir .', 'use_colors': 'True', 'static_parser': 'True', 'warn_error': 'None', 'target_path': 'None', 'partial_parse': 'True', 'write_json': 'True', 'printer_width': '80', 'debug': 'False', 'indirect_selection': 'eager', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'cache_selected_only': 'False', 'version_check': 'True', 'introspect': 'True', 'profiles_dir': '.'}
[0m21:10:08.784418 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m21:10:08.785333 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m21:10:08.785828 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m21:10:08.963541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48def8320>]}
[0m21:10:09.021872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c4db2db0>]}
[0m21:10:09.023551 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m21:10:09.129584 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m21:10:09.279507 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:10:09.280253 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:10:09.313831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48dc0a090>]}
[0m21:10:09.393499 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:10:09.397572 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:10:09.433922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48d53fbc0>]}
[0m21:10:09.434633 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m21:10:09.435157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48d618b30>]}
[0m21:10:09.437000 [info ] [MainThread]: 
[0m21:10:09.437557 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:10:09.438017 [info ] [MainThread]: 
[0m21:10:09.438678 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:10:09.443590 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m21:10:09.484908 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m21:10:09.485632 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m21:10:09.486033 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:10:10.402494 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.916 seconds
[0m21:10:10.407059 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m21:10:10.421071 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m21:10:10.421830 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m21:10:10.604551 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.182 seconds
[0m21:10:10.607668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48d7b99d0>]}
[0m21:10:10.611475 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m21:10:10.612127 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m21:10:10.612676 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m21:10:10.613098 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m21:10:10.621186 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m21:10:10.626980 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m21:10:10.656382 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m21:10:10.667380 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m21:10:10.668331 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m21:10:11.158538 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.489 seconds
[0m21:10:11.184231 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c6dbeb40>]}
[0m21:10:11.185260 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.57s]
[0m21:10:11.186061 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m21:10:11.187372 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m21:10:11.187984 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m21:10:11.188602 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m21:10:11.189188 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m21:10:11.193542 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m21:10:11.199839 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m21:10:11.225209 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m21:10:11.233233 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m21:10:11.234009 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m21:10:13.135504 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.902 seconds
[0m21:10:13.138363 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48c628440>]}
[0m21:10:13.139170 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 1.95s]
[0m21:10:13.140056 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m21:10:13.140694 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m21:10:13.141375 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m21:10:13.142025 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m21:10:13.142623 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m21:10:13.147161 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:10:13.153229 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m21:10:13.259055 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:10:13.266370 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m21:10:13.267102 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m21:10:15.011497 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.744 seconds
[0m21:10:15.013985 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '785629c3-e6da-4a0b-bdce-05e9bdfbc20f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48c63ad80>]}
[0m21:10:15.014844 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 1.87s]
[0m21:10:15.015802 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m21:10:15.017426 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:10:15.017808 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m21:10:15.018173 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m21:10:15.255133 [info ] [MainThread]: 
[0m21:10:15.255971 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 5.82 seconds (5.82s).
[0m21:10:15.257378 [debug] [MainThread]: Command end result
[0m21:10:15.293025 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:10:15.297325 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:10:15.306331 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m21:10:15.307272 [info ] [MainThread]: 
[0m21:10:15.307927 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:10:15.308423 [info ] [MainThread]: 
[0m21:10:15.308920 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m21:10:15.310208 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.56915, "process_in_blocks": "0", "process_kernel_time": 1.319588, "process_mem_max_rss": "266688", "process_out_blocks": "16", "process_user_time": 3.87879}
[0m21:10:15.310826 [debug] [MainThread]: Command `dbt run` succeeded at 21:10:15.310726 after 7.57 seconds
[0m21:10:15.311353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c46a49b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4c53f4fb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff48f690f50>]}
[0m21:10:15.311827 [debug] [MainThread]: Flushing usage events
[0m21:10:15.472904 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:12:42.225783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9409c42de0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9408eaa180>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f94096388c0>]}


============================== 21:12:42.267663 | e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3 ==============================
[0m21:12:42.267663 [info ] [MainThread]: Running with dbt=1.10.15
[0m21:12:42.268590 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'log_cache_events': 'False', 'target_path': 'None', 'debug': 'False', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '.', 'cache_selected_only': 'False', 'partial_parse': 'True', 'introspect': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'write_json': 'True', 'log_path': '/usr/local/airflow/include/nba_dw_project/logs', 'static_parser': 'True', 'empty': 'False', 'fail_fast': 'False', 'printer_width': '80', 'invocation_command': 'dbt run --profiles-dir .', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'use_experimental_parser': 'False', 'use_colors': 'True', 'quiet': 'False'}
[0m21:12:43.250116 [debug] [MainThread]: Snowflake adapter: Setting snowflake.connector to ERROR (file logging only)
[0m21:12:43.250989 [debug] [MainThread]: Snowflake adapter: Setting botocore to ERROR (file logging only)
[0m21:12:43.251481 [debug] [MainThread]: Snowflake adapter: Setting boto3 to ERROR (file logging only)
[0m21:12:43.438816 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d245ae40>]}
[0m21:12:43.499015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d38c82c0>]}
[0m21:12:43.500528 [info ] [MainThread]: Registered adapter: snowflake=1.10.3
[0m21:12:43.607613 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m21:12:43.749430 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:12:43.750290 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:12:43.782628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d1f60800>]}
[0m21:12:43.867252 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:12:43.871732 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:12:43.907135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d268f440>]}
[0m21:12:43.907893 [info ] [MainThread]: Found 3 models, 1 source, 504 macros
[0m21:12:43.908715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9408c53260>]}
[0m21:12:43.910737 [info ] [MainThread]: 
[0m21:12:43.911379 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:12:43.911845 [info ] [MainThread]: 
[0m21:12:43.912523 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:12:43.917345 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_MLDS430'
[0m21:12:43.956977 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430"
[0m21:12:43.957690 [debug] [ThreadPool]: On list_MLDS430: show terse schemas in database MLDS430
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430"} */
[0m21:12:43.958484 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:12:44.939989 [debug] [ThreadPool]: SQL status: SUCCESS 101 in 0.981 seconds
[0m21:12:44.944601 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_MLDS430, now list_MLDS430_MARMOT_FINAL)
[0m21:12:44.958736 [debug] [ThreadPool]: Using snowflake connection "list_MLDS430_MARMOT_FINAL"
[0m21:12:44.959492 [debug] [ThreadPool]: On list_MLDS430_MARMOT_FINAL: show objects in MLDS430.MARMOT_FINAL
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "connection_name": "list_MLDS430_MARMOT_FINAL"} */;
[0m21:12:45.134617 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.175 seconds
[0m21:12:45.137779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d1d15940>]}
[0m21:12:45.141090 [debug] [Thread-1 (]: Began running node model.nba_dw_project.stg_nba_stats
[0m21:12:45.142041 [info ] [Thread-1 (]: 1 of 3 START sql view model MARMOT_FINAL.stg_nba_stats ......................... [RUN]
[0m21:12:45.142875 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_MLDS430_MARMOT_FINAL, now model.nba_dw_project.stg_nba_stats)
[0m21:12:45.143368 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.stg_nba_stats
[0m21:12:45.151820 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.stg_nba_stats"
[0m21:12:45.156868 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.stg_nba_stats
[0m21:12:45.186172 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.stg_nba_stats"
[0m21:12:45.196426 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.stg_nba_stats"
[0m21:12:45.197310 [debug] [Thread-1 (]: On model.nba_dw_project.stg_nba_stats: create or replace   view MLDS430.MARMOT_FINAL.stg_nba_stats
  
  
  
  
  as (
    

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated
  )
/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.stg_nba_stats"} */;
[0m21:12:45.695675 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.498 seconds
[0m21:12:45.719901 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f940b297110>]}
[0m21:12:45.720918 [info ] [Thread-1 (]: 1 of 3 OK created sql view model MARMOT_FINAL.stg_nba_stats .................... [[32mSUCCESS 1[0m in 0.58s]
[0m21:12:45.721921 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.stg_nba_stats
[0m21:12:45.723195 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season
[0m21:12:45.723724 [info ] [Thread-1 (]: 2 of 3 START sql table model MARMOT_FINAL.fact_player_season ................... [RUN]
[0m21:12:45.724261 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.stg_nba_stats, now model.nba_dw_project.fact_player_season)
[0m21:12:45.724804 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season
[0m21:12:45.728429 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season"
[0m21:12:45.733551 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season
[0m21:12:45.757635 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season"
[0m21:12:45.764778 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season"
[0m21:12:45.765410 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    games_played,
    games_started,
    minutes_played,
    
    -- Core Statistics
    points,
    assists,
    total_rebounds,
    steals,
    blocks,
    turnovers,
    personal_fouls,
    
    -- Shooting Stats
    field_goals,
    field_goal_attempts,
    field_goal_pct,
    three_pointers,
    three_point_attempts,
    three_point_pct,
    two_pointers,
    two_point_attempts,
    two_point_pct,
    effective_field_goal_pct,
    free_throws,
    free_throw_attempts,
    free_throw_pct,
    
    -- Rebounding
    offensive_rebounds,
    defensive_rebounds,
    
    -- Per-Game Metrics (CALCULATED)
    CASE WHEN games_played > 0 THEN points / games_played ELSE NULL END as points_per_game,
    CASE WHEN games_played > 0 THEN assists / games_played ELSE NULL END as assists_per_game,
    CASE WHEN games_played > 0 THEN total_rebounds / games_played ELSE NULL END as rebounds_per_game,
    CASE WHEN games_played > 0 THEN steals / games_played ELSE NULL END as steals_per_game,
    CASE WHEN games_played > 0 THEN blocks / games_played ELSE NULL END as blocks_per_game,
    CASE WHEN games_played > 0 THEN turnovers / games_played ELSE NULL END as turnovers_per_game,
    
    -- Per-36 Minutes Metrics (CALCULATED)
    CASE WHEN minutes_played > 0 THEN (points / minutes_played) * 36 ELSE NULL END as points_per_36min,
    CASE WHEN minutes_played > 0 THEN (assists / minutes_played) * 36 ELSE NULL END as assists_per_36min,
    CASE WHEN minutes_played > 0 THEN (total_rebounds / minutes_played) * 36 ELSE NULL END as rebounds_per_36min,
    CASE WHEN minutes_played > 0 THEN (steals / minutes_played) * 36 ELSE NULL END as steals_per_36min,
    CASE WHEN minutes_played > 0 THEN (blocks / minutes_played) * 36 ELSE NULL END as blocks_per_36min,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season"} */;
[0m21:12:48.002391 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.236 seconds
[0m21:12:48.004990 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f940b1b9f70>]}
[0m21:12:48.005732 [info ] [Thread-1 (]: 2 of 3 OK created sql table model MARMOT_FINAL.fact_player_season .............. [[32mSUCCESS 1[0m in 2.28s]
[0m21:12:48.006506 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season
[0m21:12:48.007122 [debug] [Thread-1 (]: Began running node model.nba_dw_project.fact_player_season_advanced
[0m21:12:48.007789 [info ] [Thread-1 (]: 3 of 3 START sql table model MARMOT_FINAL.fact_player_season_advanced .......... [RUN]
[0m21:12:48.008539 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.nba_dw_project.fact_player_season, now model.nba_dw_project.fact_player_season_advanced)
[0m21:12:48.009261 [debug] [Thread-1 (]: Began compiling node model.nba_dw_project.fact_player_season_advanced
[0m21:12:48.013935 [debug] [Thread-1 (]: Writing injected SQL for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:12:48.019744 [debug] [Thread-1 (]: Began executing node model.nba_dw_project.fact_player_season_advanced
[0m21:12:48.135583 [debug] [Thread-1 (]: Writing runtime sql for node "model.nba_dw_project.fact_player_season_advanced"
[0m21:12:48.142405 [debug] [Thread-1 (]: Using snowflake connection "model.nba_dw_project.fact_player_season_advanced"
[0m21:12:48.143286 [debug] [Thread-1 (]: On model.nba_dw_project.fact_player_season_advanced: create or replace transient table MLDS430.MARMOT_FINAL.fact_player_season_advanced
    
    
    
    as (

SELECT 
    season_year,
    player_name,
    position,
    age,
    team_code,
    
    -- Advanced Efficiency Metrics
    player_efficiency_rating as PER,
    true_shooting_pct as TS_PCT,
    three_point_attempt_rate as ThreePAr,
    free_throw_rate as FTr,
    effective_field_goal_pct as eFG_PCT,
    
    -- Percentage Stats
    offensive_rebound_pct as ORB_PCT,
    defensive_rebound_pct as DRB_PCT,
    total_rebound_pct as TRB_PCT,
    assist_pct as AST_PCT,
    steal_pct as STL_PCT,
    block_pct as BLK_PCT,
    turnover_pct as TOV_PCT,
    usage_pct as USG_PCT,
    
    -- Win Shares
    offensive_win_shares as OWS,
    defensive_win_shares as DWS,
    win_shares as WS,
    win_shares_per_48 as WS_48,
    
    -- Plus/Minus Metrics
    offensive_box_plus_minus as OBPM,
    defensive_box_plus_minus as DBPM,
    box_plus_minus as BPM,
    value_over_replacement_player as VORP,
    
    -- Calculated Efficiency Ratios (need base fields from staging)
    CASE WHEN turnovers > 0 THEN assists / turnovers ELSE NULL END as assist_to_turnover_ratio,
    CASE WHEN personal_fouls > 0 THEN points / personal_fouls ELSE NULL END as points_per_foul,
    CASE WHEN field_goal_attempts > 0 THEN points / field_goal_attempts ELSE NULL END as points_per_fga,
    
    -- Usage and Efficiency Combined
    CASE 
        WHEN minutes_played > 0 AND games_played > 0 
        THEN (minutes_played / (games_played * 48)) * 100 
        ELSE NULL 
    END as minutes_usage_rate,
    
    -- Base fields needed for calculations (from staging)
    assists,
    turnovers,
    points,
    personal_fouls,
    field_goal_attempts,
    minutes_played,
    games_played,
    
    extraction_timestamp
FROM MLDS430.MARMOT_FINAL.stg_nba_stats
    )

/* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "nba_dw_project", "target_name": "dev", "node_id": "model.nba_dw_project.fact_player_season_advanced"} */;
[0m21:12:50.010660 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 1.867 seconds
[0m21:12:50.013640 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e465e1bb-c094-4ea3-aa4f-7bc28f1b34e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d038eb10>]}
[0m21:12:50.014384 [info ] [Thread-1 (]: 3 of 3 OK created sql table model MARMOT_FINAL.fact_player_season_advanced ..... [[32mSUCCESS 1[0m in 2.01s]
[0m21:12:50.015077 [debug] [Thread-1 (]: Finished running node model.nba_dw_project.fact_player_season_advanced
[0m21:12:50.017043 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:12:50.017837 [debug] [MainThread]: Connection 'model.nba_dw_project.fact_player_season_advanced' was left open.
[0m21:12:50.018308 [debug] [MainThread]: On model.nba_dw_project.fact_player_season_advanced: Close
[0m21:12:50.235627 [info ] [MainThread]: 
[0m21:12:50.236643 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 6.32 seconds (6.32s).
[0m21:12:50.237870 [debug] [MainThread]: Command end result
[0m21:12:50.274516 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/local/airflow/include/nba_dw_project/target/manifest.json
[0m21:12:50.279950 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/local/airflow/include/nba_dw_project/target/semantic_manifest.json
[0m21:12:50.289081 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/local/airflow/include/nba_dw_project/target/run_results.json
[0m21:12:50.289706 [info ] [MainThread]: 
[0m21:12:50.290390 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:12:50.291010 [info ] [MainThread]: 
[0m21:12:50.291657 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m21:12:50.293174 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.12998, "process_in_blocks": "0", "process_kernel_time": 1.403204, "process_mem_max_rss": "267264", "process_out_blocks": "16", "process_user_time": 3.957238}
[0m21:12:50.293989 [debug] [MainThread]: Command `dbt run` succeeded at 21:12:50.293850 after 8.13 seconds
[0m21:12:50.294504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f94093b8c80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d10f9ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d8b201a0>]}
[0m21:12:50.294970 [debug] [MainThread]: Flushing usage events
[0m21:12:50.460108 [debug] [MainThread]: An error was encountered while trying to flush usage events
