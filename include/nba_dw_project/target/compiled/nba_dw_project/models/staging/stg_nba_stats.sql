

WITH raw_data AS (
    SELECT *
    FROM MLDS430.MARMOT_FINAL.RAW_NBA_STATS
    WHERE "Year" >= 1984  -- Filter for years 1984 and later
      AND "Year" IS NOT NULL
      AND "Player" IS NOT NULL
),

-- Step 1: Drop 'Unnamed:_0' and blank columns, clean data
cleaned_data AS (
    SELECT 
        CAST("Year" AS INTEGER) as season_year,
        "Player" as player_name,
        "Pos" as position,
        CAST("Age" AS FLOAT) as age,
        "Tm" as team_code,
        CAST("G" AS FLOAT) as games_played,
        CAST("GS" AS FLOAT) as games_started,
        CAST("MP" AS FLOAT) as minutes_played,
        CAST("PER" AS FLOAT) as player_efficiency_rating,
        CAST("TS_PCT" AS FLOAT) as true_shooting_pct,
        CAST("ThreePAr" AS FLOAT) as three_point_attempt_rate,
        CAST("FTr" AS FLOAT) as free_throw_rate,
        CAST("ORB_PCT" AS FLOAT) as offensive_rebound_pct,
        CAST("DRB_PCT" AS FLOAT) as defensive_rebound_pct,
        CAST("TRB_PCT" AS FLOAT) as total_rebound_pct,
        CAST("AST_PCT" AS FLOAT) as assist_pct,
        CAST("STL_PCT" AS FLOAT) as steal_pct,
        CAST("BLK_PCT" AS FLOAT) as block_pct,
        CAST("TOV_PCT" AS FLOAT) as turnover_pct,
        CAST("USG_PCT" AS FLOAT) as usage_pct,
        CAST("OWS" AS FLOAT) as offensive_win_shares,
        CAST("DWS" AS FLOAT) as defensive_win_shares,
        CAST("WS" AS FLOAT) as win_shares,
        CAST("WS_48" AS FLOAT) as win_shares_per_48,
        CAST("OBPM" AS FLOAT) as offensive_box_plus_minus,
        CAST("DBPM" AS FLOAT) as defensive_box_plus_minus,
        CAST("BPM" AS FLOAT) as box_plus_minus,
        CAST("VORP" AS FLOAT) as value_over_replacement_player,
        CAST("FG" AS FLOAT) as field_goals,
        CAST("FGA" AS FLOAT) as field_goal_attempts,
        CAST("FG_PCT" AS FLOAT) as field_goal_pct,
        CAST("ThreeP" AS FLOAT) as three_pointers,
        CAST("ThreePA" AS FLOAT) as three_point_attempts,
        CAST("ThreeP_PCT" AS FLOAT) as three_point_pct,
        CAST("TwoP" AS FLOAT) as two_pointers,
        CAST("TwoPA" AS FLOAT) as two_point_attempts,
        CAST("TwoP_PCT" AS FLOAT) as two_point_pct,
        CAST("eFG_PCT" AS FLOAT) as effective_field_goal_pct,
        CAST("FT" AS FLOAT) as free_throws,
        CAST("FTA" AS FLOAT) as free_throw_attempts,
        CAST("FT_PCT" AS FLOAT) as free_throw_pct,
        CAST("ORB" AS FLOAT) as offensive_rebounds,
        CAST("DRB" AS FLOAT) as defensive_rebounds,
        CAST("TRB" AS FLOAT) as total_rebounds,
        CAST("AST" AS FLOAT) as assists,
        CAST("STL" AS FLOAT) as steals,
        CAST("BLK" AS FLOAT) as blocks,
        CAST("TOV" AS FLOAT) as turnovers,
        CAST("PF" AS FLOAT) as personal_fouls,
        CAST("PTS" AS FLOAT) as points,
        CURRENT_TIMESTAMP() as extraction_timestamp
    FROM raw_data
    -- Filter out rows where key stats are all null
    WHERE ("PTS" IS NOT NULL OR "AST" IS NOT NULL OR "TRB" IS NOT NULL)
),

-- Step 2 & 3: Consolidate players with multiple teams in same season
-- Group by Year and Player, aggregate numeric stats (average), take first team/position/age
ranked_data AS (
    SELECT 
        season_year,
        player_name,
        position,
        age,
        team_code,
        games_played,
        games_started,
        minutes_played,
        player_efficiency_rating,
        true_shooting_pct,
        three_point_attempt_rate,
        free_throw_rate,
        offensive_rebound_pct,
        defensive_rebound_pct,
        total_rebound_pct,
        assist_pct,
        steal_pct,
        block_pct,
        turnover_pct,
        usage_pct,
        offensive_win_shares,
        defensive_win_shares,
        win_shares,
        win_shares_per_48,
        offensive_box_plus_minus,
        defensive_box_plus_minus,
        box_plus_minus,
        value_over_replacement_player,
        field_goals,
        field_goal_attempts,
        field_goal_pct,
        three_pointers,
        three_point_attempts,
        three_point_pct,
        two_pointers,
        two_point_attempts,
        two_point_pct,
        effective_field_goal_pct,
        free_throws,
        free_throw_attempts,
        free_throw_pct,
        offensive_rebounds,
        defensive_rebounds,
        total_rebounds,
        assists,
        steals,
        blocks,
        turnovers,
        personal_fouls,
        points,
        extraction_timestamp,
        ROW_NUMBER() OVER (PARTITION BY season_year, player_name ORDER BY extraction_timestamp) as rn
    FROM cleaned_data
),

consolidated AS (
    SELECT 
        season_year,
        player_name,
        -- Take first value for categorical fields
        MAX(CASE WHEN rn = 1 THEN position END) as position,
        MAX(CASE WHEN rn = 1 THEN age END) as age,
        MAX(CASE WHEN rn = 1 THEN team_code END) as team_code,
        -- Average numeric statistics for multi-team players
        AVG(games_played) as games_played,
        AVG(games_started) as games_started,
        AVG(minutes_played) as minutes_played,
        AVG(player_efficiency_rating) as player_efficiency_rating,
        AVG(true_shooting_pct) as true_shooting_pct,
        AVG(three_point_attempt_rate) as three_point_attempt_rate,
        AVG(free_throw_rate) as free_throw_rate,
        AVG(offensive_rebound_pct) as offensive_rebound_pct,
        AVG(defensive_rebound_pct) as defensive_rebound_pct,
        AVG(total_rebound_pct) as total_rebound_pct,
        AVG(assist_pct) as assist_pct,
        AVG(steal_pct) as steal_pct,
        AVG(block_pct) as block_pct,
        AVG(turnover_pct) as turnover_pct,
        AVG(usage_pct) as usage_pct,
        AVG(offensive_win_shares) as offensive_win_shares,
        AVG(defensive_win_shares) as defensive_win_shares,
        AVG(win_shares) as win_shares,
        AVG(win_shares_per_48) as win_shares_per_48,
        AVG(offensive_box_plus_minus) as offensive_box_plus_minus,
        AVG(defensive_box_plus_minus) as defensive_box_plus_minus,
        AVG(box_plus_minus) as box_plus_minus,
        AVG(value_over_replacement_player) as value_over_replacement_player,
        AVG(field_goals) as field_goals,
        AVG(field_goal_attempts) as field_goal_attempts,
        AVG(field_goal_pct) as field_goal_pct,
        AVG(three_pointers) as three_pointers,
        AVG(three_point_attempts) as three_point_attempts,
        AVG(three_point_pct) as three_point_pct,
        AVG(two_pointers) as two_pointers,
        AVG(two_point_attempts) as two_point_attempts,
        AVG(two_point_pct) as two_point_pct,
        AVG(effective_field_goal_pct) as effective_field_goal_pct,
        AVG(free_throws) as free_throws,
        AVG(free_throw_attempts) as free_throw_attempts,
        AVG(free_throw_pct) as free_throw_pct,
        AVG(offensive_rebounds) as offensive_rebounds,
        AVG(defensive_rebounds) as defensive_rebounds,
        AVG(total_rebounds) as total_rebounds,
        AVG(assists) as assists,
        AVG(steals) as steals,
        AVG(blocks) as blocks,
        AVG(turnovers) as turnovers,
        AVG(personal_fouls) as personal_fouls,
        AVG(points) as points,
        MAX(extraction_timestamp) as extraction_timestamp
    FROM ranked_data
    GROUP BY season_year, player_name
)

SELECT *
FROM consolidated